
@page "/Chat"
@page "/Chat/{SessionId:guid}"
@using ChatGptBlazorCore.Models
@using Markdig
@using Serilog
@using ServiceAccessLayer.AiServices
@using Blazored.Toast.Services
@using System.Globalization
@inject IOpenAiClient OpenAiClient
@inject IToastService ToastService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserRepository UserRepository
@inject IChatSessionRepository ChatSessionRepository


<h3>Chat</h3>
<div>
    @SessionId.ToString()
</div>

<div class="row">
    <div class="col-md-3">
        <div class="sidebar">
            <div class="nav-scrollable">
                <div class="nav-item">
                    <button class="btn btn-primary" @onclick="NavigateToNewChat">New chat</button>
                </div>
                @foreach (var sessionTopicTuple in _sessionTopics)
                {
                    <div class="nav-item px-3">
                        <NavLink class="nav-link" href="@GetChatSessionLink(sessionTopicTuple.Id)">
                            <span class="" aria-hidden="true">@GetSessionDescription(sessionTopicTuple)</span>
                        </NavLink>
                    </div>
                }

            </div>

        </div>
    </div>
    <div class="col-md-9">
        <form onsubmit="@Send">

            <div class="mb-3">
                <label for="chatTopic" class="form-label">Topic</label>
                <input type="text" class="form-control" id="chatTopic" @bind="_currentSession.Topic"/>
            </div>
            <div class="mb-3">
                <label for="chatTags" class="form-label">Tags</label>
                @{
                    var tags = string.Join(";", _currentSession.Tags);
                    <input type="text" class="form-control" id="chatTags" @bind="@tags"/>
                }
            </div>

            <div class="mb-3">
                <label for="chatInput" class="form-label">User prompt:</label>
                <textarea class="form-control"  id="chatInput" @bind="_currentPrompt"></textarea>
            </div>

            <div class="col-md-2">
                <button type="submit" class="form-control mt-2 btn btn-primary">Send</button>
            </div>


        </form>
        @if (_waitingForResponse)
        {
            <div class="row m-1">Waiting for response....</div>
        }
        <div class="row" id="chatOutput">
            <ul>
                @foreach (var reply in _currentSession.Entries)
                {
                    var contentHtml = Markdown.ToHtml(reply.Content);

                    <li>
                        @reply.Role:
                        <div>@((MarkupString)contentHtml)</div>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>


@code {

    [Parameter]
    public Guid? SessionId { get; set; }

    bool _waitingForResponse;
    string _currentPrompt = "";
    ChatSession _currentSession;

    (Guid Id, string Topic, DateTime Created)[] _sessionTopics = Array.Empty<(Guid Id, string Topic, DateTime Created)>();


    protected override async Task OnInitializedAsync()
    {
        var authState = AuthenticationStateProvider.GetAuthenticationStateAsync();
        var principal = authState.Result.User;


        var user = await
            UserRepository.GetUserAsync(principal.Identity.Name);

        var sessionTopics = await ChatSessionRepository.GetUserChatSessionTopicsAsync(user.Id);
        _sessionTopics = sessionTopics.OrderByDescending(topic => topic.Created).ToArray();

        if (SessionId.HasValue)
        {
            var session = await ChatSessionRepository.GetChatSessionAsync(SessionId.Value, user.Id);
            if (session != null)
            {
                _currentSession = session;
            }
        }
        else
        {
            _currentSession = new ChatSession(user.Id)
            {
                Entries = new List<ChatEntry>(),
                Topic = "New topic"
            };

            await ChatSessionRepository.AddChatSessionAsync(_currentSession);


            NavigationManager.NavigateTo($"/Chat/{_currentSession.Id}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = AuthenticationStateProvider.GetAuthenticationStateAsync();
        var principal = authState.Result.User;


        var user = await
            UserRepository.GetUserAsync(principal.Identity.Name);
        if (SessionId.HasValue)
        {
            var session = await ChatSessionRepository.GetChatSessionAsync(SessionId.Value, user.Id);
            if (session != null)
            {
                _currentSession = session;
            }
            else
            {
                _currentSession = new ChatSession(Guid.NewGuid(), user.Id)
                {
                    Entries = new List<ChatEntry>(),
                    Topic = "New topic"
                };
                ChatSessionRepository.AddChatSessionAsync(_currentSession);

                NavigationManager.NavigateTo($"/Chat/{_currentSession.Id}");
            }
        }


        var updatedTopics = await GetSessionTopics(_currentSession.UserId);
        _sessionTopics = updatedTopics;


        await base.OnParametersSetAsync();
    }

    private async Task Send()
    {
        _waitingForResponse = true;

        var replies = _currentSession.Entries.Select(e => (e.Role, e.Content)).ToList();
        var result = await OpenAiClient.GetCompletionAsync(replies, _currentPrompt);

        if (result.Success)
        {
            _currentSession.Entries.Add(new ChatEntry { Role = "user", Content = _currentPrompt });
            _currentSession.Entries.Add(new ChatEntry { Role = "assistant", Content = result.Content });
        }
        else
        {
            ToastService.ShowError(result.Errors.First());
        }
        replies = _currentSession.Entries.Select(e => (e.Role, e.Content)).ToList();
        var topicResponse = await OpenAiClient.GetChatTopicAsync(replies.ToArray());
        if (topicResponse.Success)
        {
            _currentSession.Topic = topicResponse.Content;

            var updateResult = await ChatSessionRepository.UpdateChatSessionAsync(_currentSession);
            if (!updateResult.Ok)
            {
                ToastService.ShowError(updateResult.Errors.First());
            }

            var updatedTopics = await GetSessionTopics(_currentSession.UserId);
            _sessionTopics = updatedTopics;
        }
        else
        {
            ToastService.ShowError(topicResponse.Errors.First());
        }
        var tags = await GetTagsAsync(_currentSession.Entries);
        _currentSession.Tags = tags.ToList();

        _currentPrompt = string.Empty;
        _waitingForResponse = false;
    }

    private string GetChatSessionLink(Guid? sessionId)
    {
        if (sessionId == null)
            return $"chat/{Guid.NewGuid()}";

        return $"chat/{sessionId}";
    }

    private object GetSessionDescription((Guid Id, string Topic, DateTime Created) sessionTopicTuple)
    {
        return $"{sessionTopicTuple.Topic} {sessionTopicTuple.Created.ToString("yy-MM-dd", CultureInfo.CurrentCulture)}";
    }


    private async Task NavigateToNewChat()
    {
        var authState = AuthenticationStateProvider.GetAuthenticationStateAsync();
        var principal = authState.Result.User;
        var user = await
            UserRepository.GetUserAsync(principal.Identity.Name);

        _currentSession = new ChatSession(Guid.NewGuid(), user.Id)
        {
            Entries = new List<ChatEntry>(),
            Topic = "New topic"
        };
        await ChatSessionRepository.AddChatSessionAsync(_currentSession);

        NavigationManager.NavigateTo($"/Chat/{_currentSession.Id}");
    }

    private async Task<string[]> GetTagsAsync(IEnumerable<ChatEntry> entries)
    {
        var tags = Array.Empty<string>();
        var messages = entries.Select(e => (e.Role, e.Content)).ToArray();
        var response = await OpenAiClient.GetChatTagsAsync(messages);
        if (response.Success)
        {
            var tagsString = response.Content;
            tags = tagsString.Split(';');
        }
        else
        {
            ToastService.ShowError("Failed to fetch tags");

            foreach (var error in response.Errors)
            {
                Log.Logger.Error("Failed to fetch tags: {Error}", error, error);
            }
        }


        return tags;
    }

    private async Task<(Guid Id, string Topic, DateTime Created)[]> GetSessionTopics(Guid userId)
    {
        var sessionTopics = await ChatSessionRepository.GetUserChatSessionTopicsAsync(userId);
        return sessionTopics.OrderByDescending(topic => topic.Created).ToArray();
    }


}